<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>HOR4R:1O5 ‚Äì COTEC</title>
    <link rel="icon" type="image/png" href="horarios.png">
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@500;700&family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #020617; --card: #0f172a; --accent: #6366f1;
            --green: #10b981; --red: #ef4444; --orange: #f59e0b;
            --text: #f1f5f9; --border: rgba(99, 102, 241, 0.2);
        }
        * { margin:0; padding:0; box-sizing:border-box; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; }
        
        /* Cabe√ßalho Ajustado (Corre√ß√£o Solicitada) */
        .top-nav { background: var(--card); border-bottom: 2px solid var(--accent); padding: 15px 40px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .brand-container { display: flex; align-items: center; gap: 20px; }
        .logo-img { height: 80px; width: auto; filter: drop-shadow(0 0 10px rgba(99, 102, 241, 0.5)); }
        
        /* AQUI EST√Å A CORRE√á√ÉO: Flex column para alinhar um abaixo do outro */
        .inst-brand { display: flex; flex-direction: column; justify-content: center; }
        .inst-title { font-weight: 800; font-size: 24px; color: var(--accent); line-height: 1.1; }
        .inst-sub { font-size: 12px; opacity: 0.8; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }

        /* Layout */
        .dashboard { display: grid; grid-template-columns: 350px 1fr; gap: 20px; padding: 20px; flex-grow: 1; }
        .glass { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.4); margin-bottom: 20px; }
        
        /* Abas */
        .tab-container { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab-btn { padding: 12px 24px; background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: white; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .tab-btn.active { background: var(--accent); border-color: var(--accent); box-shadow: 0 0 15px var(--accent); }

        /* Calend√°rio */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .cal-day { min-height: 110px; border: 1px solid var(--border); border-radius: 12px; padding: 10px; cursor: pointer; background: rgba(255,255,255,0.02); position: relative; transition: 0.2s; }
        .cal-day:hover { border-color: var(--accent); background: rgba(99, 102, 241, 0.05); }
        .day-selected { border: 2px solid var(--accent) !important; background: rgba(99, 102, 241, 0.1); }
        .day-num { font-weight: 800; font-size: 16px; }
        .day-off { opacity: 0.5; background: rgba(0,0,0,0.3); }
        .day-feriado { border-top: 3px solid var(--orange); }
        
        /* Indicadores de Atendimento */
        .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-top: 5px; }
        .dot-red { background: var(--red); box-shadow: 0 0 8px var(--red); }
        .dot-orange { background: var(--orange); box-shadow: 0 0 8px var(--orange); }
        .dot-green { background: var(--green); box-shadow: 0 0 8px var(--green); }
        .emoji-happy { font-size: 16px; display: block; margin-top: 2px; }

        /* Componentes */
        .srv-item { background: rgba(255,255,255,0.03); border: 1px solid var(--border); border-radius: 12px; padding: 12px; margin-bottom: 8px; }
        .btn { background: var(--accent); color: white; border: none; padding: 10px 18px; border-radius: 8px; cursor: pointer; font-weight: 700; font-size: 11px; }
        .btn-outline { background: transparent; border: 1px solid var(--border); }
        .input-std { background: #000; border: 1px solid var(--border); color: #fff; padding: 10px; border-radius: 8px; width: 100%; margin-bottom: 10px; }

        /* Modais */
        .modal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:2000; width:95%; max-width:1000px; max-height: 90vh; overflow-y: auto; background: #0f172a; border: 2px solid var(--accent); border-radius: 24px; padding: 30px; }
        #overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:1500; backdrop-filter:blur(8px); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: rgba(255,255,255,0.02); }
        th, td { border: 1px solid var(--border); padding: 12px; text-align: left; font-size: 12px; }
        th { background: rgba(99, 102, 241, 0.2); color: var(--accent); }

        @media print {
            body * { visibility: hidden; }
            #report-print-area, #report-print-area * { visibility: visible; }
            #report-print-area { position: absolute; left: 0; top: 0; width: 100%; display: block !important; color: black !important; }
        }
    </style>
</head>
<body>

<nav class="top-nav">
    <div class="brand-container">
        <img src="horarios.png" class="logo-img" alt="COTEC">
        <div class="inst-brand">
            <span class="inst-title">HOR4R:1O5 ‚Äì COTEC</span>
            <span class="inst-sub">DEPARTAMENTO DE POL√çCIA LEGISLATIVA</span>
        </div>
    </div>
    <div style="display:flex; gap:10px;">
        <button class="btn btn-outline" onclick="UI.showReports()">üìä RELAT√ìRIOS</button>
        <button class="btn btn-outline" onclick="UI.showFeriados()">üìÖ FERIADOS</button>
        <button class="btn" onclick="Admin.exportData()">üíæ BACKUP LOCAL</button>
    </div>
</nav>

<div class="dashboard">
    <aside>
        <div class="glass">
            <h3 style="font-size:11px; color:var(--accent); margin-bottom:10px;">HORA ATUAL <span id="live-clock" style="float:right">--:--</span></h3>
            <div id="live-summary" style="font-size:11px; opacity:0.8;"></div>
        </div>

        <div class="glass">
            <h3 style="font-size:11px; color:var(--orange); margin-bottom:10px;">üî¥ ALERTA DE F√âRIAS (15 DIAS)</h3>
            <div id="alert-list" style="max-height: 150px; overflow-y:auto"></div>
        </div>

        <div class="glass" style="max-height: 40vh; overflow-y: auto;">
            <h3 style="font-size: 11px; opacity: 0.5; margin-bottom: 10px;">EFETIVO CADASTRADO</h3>
            <div id="srv-list"></div>
            <button class="btn btn-outline" style="width:100%;" onclick="Admin.addSrv()">+ ADICIONAR SERVIDOR</button>
        </div>
    </aside>

    <main>
        <div class="tab-container">
            <button class="tab-btn active" id="btn-main" onclick="UI.switchTab('main')">CALEND√ÅRIO DE ESCALA</button>
            <button class="tab-btn" id="btn-apoio" onclick="UI.switchTab('apoio')">SISTEMA DE APOIO</button>
        </div>

        <section id="tab-main">
            <div class="glass">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <button onclick="UI.changeMonth(-1)" class="btn btn-outline">‚óÑ ANTERIOR</button>
                    <h2 id="mes-label" style="text-transform: uppercase; letter-spacing: 2px;"></h2>
                    <button onclick="UI.changeMonth(1)" class="btn btn-outline">PR√ìXIMO ‚ñ∫</button>
                </div>
                <div id="calendar-grid" class="calendar-grid"></div>
                
                <div style="margin-top: 30px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h3 id="sel-date-label" style="color:var(--accent); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom:15px"></h3>
                        <div id="presence-list"></div>
                    </div>
                    <div>
                        <h3 style="color:var(--orange); border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom:15px">OCORR√äNCIAS / AFASTAMENTOS</h3>
                        <div id="absence-list"></div>
                    </div>
                </div>
            </div>
        </section>

        <section id="tab-apoio" class="hidden">
            <div class="glass">
                <h2 style="color:var(--accent); margin-bottom:20px">GEST√ÉO DE APOIO OPERACIONAL</h2>
                <div style="display:grid; grid-template-columns: 1fr 2fr; gap:20px;">
                    <div class="srv-item">
                        <h4>LAN√áAR APOIO</h4>
                        <label style="font-size:10px">Servidor:</label>
                        <select id="apoio-srv" class="input-std"></select>
                        <label style="font-size:10px">Local Destino:</label>
                        <input type="text" id="apoio-local" class="input-std" placeholder="Ex: Portaria Norte">
                        <label style="font-size:10px">Dura√ß√£o (Horas):</label>
                        <input type="number" id="apoio-horas" class="input-std" value="1">
                        <button class="btn" style="width:100%" onclick="Admin.saveApoio()">REGISTRAR AGORA</button>
                    </div>
                    <div id="locais-container" style="max-height: 450px; overflow-y:auto"></div>
                </div>
                <div id="ranking-container" style="margin-top:40px"></div>
            </div>
        </section>
    </main>
</div>

<div id="modal-srv" class="modal"></div>
<div id="modal-feriados" class="modal">
    <h2 style="color:var(--accent); margin-bottom:20px;">CALEND√ÅRIO DE FERIADOS</h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
        <div class="glass">
            <h4>+ CADASTRAR FERIADO</h4>
            <input type="text" id="fer-nome" class="input-std" placeholder="Nome do Evento">
            <input type="date" id="fer-data" class="input-std">
            <button class="btn" style="width:100%" onclick="Admin.saveFeriado()">SALVAR NO CALEND√ÅRIO</button>
        </div>
        <div class="glass" style="max-height: 300px; overflow-y:auto" id="fer-list-ui"></div>
    </div>
    <button class="btn btn-outline" style="width:100%; margin-top:20px" onclick="UI.closeModals()">FECHAR</button>
</div>

<div id="modal-reports" class="modal">
    <h2 style="color:var(--accent); margin-bottom:20px;">CENTRAL DE RELAT√ìRIOS</h2>
    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
        <div class="srv-item">
            <h4>1. Geral por Per√≠odo</h4>
            <input type="date" id="rep-g-d1" class="input-std"><input type="date" id="rep-g-d2" class="input-std">
            <button class="btn" onclick="Reports.generateGeral()">GERAR</button>
        </div>
        <div class="srv-item">
            <h4>2. Por Evento / Tipo</h4>
            <select id="rep-e-tipo" class="input-std"></select>
            <button class="btn" onclick="Reports.generateEvento()">FILTRAR</button>
        </div>
        <div class="srv-item">
            <h4>3. Individual do Servidor</h4>
            <select id="rep-i-srv" class="input-std"></select>
            <button class="btn" onclick="Reports.generateIndividual()">VER HIST√ìRICO</button>
        </div>
        <div class="srv-item">
            <h4>4. Balan√ßo de Horas Totais</h4>
            <input type="date" id="rep-h-d1" class="input-std"><input type="date" id="rep-h-d2" class="input-std">
            <button class="btn" onclick="Reports.generateHoras()">CALCULAR</button>
        </div>
    </div>
    <button class="btn btn-outline" style="width:100%; margin-top:20px" onclick="UI.closeModals()">FECHAR</button>
</div>

<div id="report-print-area" style="display:none; background:white; color:black; padding:40px;"></div>
<div id="overlay" onclick="UI.closeModals()"></div>

<script>
/** DATABASE CONNECTED TO GOOGLE SHEETS **/
const Store = {
    // !!!!!!!!!!!! COLE SUA URL AQUI DENTRO DAS ASPAS !!!!!!!!!!!!
    apiUrl: "https://script.google.com/macros/s/AKfycbzyRfA2PoP9nm1VFgFkGylI5mf8Fnz3_-Zss4Dp_XXIyn-TPQxI-hZ7JRYOmMouZlL4/exec", 
    
    state: {
        servidores: [],
        feriados: [
            {d:"2026-01-01", n:"Confraterniza√ß√£o Universal"}, {d:"2026-04-21", n:"Tiradentes"},
            {d:"2026-05-01", n:"Dia do Trabalho"}, {d:"2026-09-07", n:"Independ√™ncia"},
            {d:"2026-10-12", n:"Nsa. Sra. Aparecida"}, {d:"2026-11-02", n:"Finados"},
            {d:"2026-11-15", n:"Proclama√ß√£o da Rep√∫blica"}, {d:"2026-12-25", n:"Natal"}
        ],
        apoios: [],
        dataFoco: new Date(),
        dataSel: new Date(),
        tiposOcc: ["F√©rias", "Licen√ßa", "Abono", "Banco de horas", "Curso", "Recesso", "Afastamento", "Falta"]
    },
    async init() {
        if(this.apiUrl) {
            try {
                const resp = await fetch(this.apiUrl);
                const data = await resp.json();
                if(data && data.servidores) { // Verifica se veio algo v√°lido
                    this.state = data;
                    // Recupera datas que viram string no JSON
                    this.state.dataFoco = new Date();
                    this.state.dataSel = new Date();
                }
            } catch(e) { console.log("Erro ao carregar da nuvem:", e); }
        }
        
        // Garante que as datas est√£o como objetos Date
        this.state.dataFoco = new Date(this.state.dataFoco || new Date());
        this.state.dataSel = new Date(this.state.dataSel || new Date());
        UI.init();
    },
    save() {
        if(this.apiUrl) {
            // Envia para o Google Sheets (Nuvem)
            fetch(this.apiUrl, {
                method: "POST",
                body: JSON.stringify(this.state)
            }).then(() => console.log("Salvo na nuvem"));
        }
        // Salva local tamb√©m por garantia
        localStorage.setItem('cotec_backup', JSON.stringify(this.state));
        UI.render();
    },
    exportData() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(this.state)], {type:'application/json'}));
        a.download = `COTEC_BACKUP_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    }
};

/** CORE LOGIC **/
const Core = {
    toMin(t) { if(!t) return 0; const [h,m] = t.split(':').map(Number); return (h*60)+m; },
    toTime(m) { return `${Math.floor(m/60).toString().padStart(2,'0')}:${(m%60).toString().padStart(2,'0')}`; },
    formatISO(date) { return new Date(date.getTime() - (date.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; },
    formatBR(iso) { if(!iso) return ""; const [y,m,d] = iso.split('-'); return `${d}/${m}/${y}`; },
    
    evaluate(srv, data) {
        const dStr = this.formatISO(data);
        const diaS = data.getDay();
        const feriado = Store.state.feriados.find(f => f.d === dStr);
        const j = srv.jornada[diaS];
        if((feriado || diaS === 0 || diaS === 6) && (!j || j.c === 0)) {
            return { code: 'OFF', label: feriado ? feriado.n : 'Folga' };
        }
        if(!j || j.c === 0) return { code: 'OFF', label: 'Sem Escala' };
        const occ = srv.occs.find(o => dStr >= o.d1 && dStr <= (o.d2 || o.d1));
        if(occ) return { code: 'ABSENT', label: occ.cat };
        return { code: 'PRESENT', label: 'Presente', h: `${this.toTime(j.i)} - ${this.toTime(j.i + (j.c*60))}` };
    }
};

/** UI CONTROLLER **/
const UI = {
    init() {
        this.render();
        setInterval(() => { document.getElementById('live-clock').innerText = new Date().toLocaleTimeString('pt-br'); }, 1000);
    },
    switchTab(tab) {
        document.getElementById('tab-main').classList.toggle('hidden', tab !== 'main');
        document.getElementById('tab-apoio').classList.toggle('hidden', tab !== 'apoio');
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`btn-${tab}`).classList.add('active');
        if(tab === 'apoio') this.renderApoio();
    },
    render() {
        this.renderSrvList(); this.renderCalendar(); this.renderAlerts(); this.selectDay(Store.state.dataSel);
        document.getElementById('rep-e-tipo').innerHTML = Store.state.tiposOcc.map(t => `<option>${t}</option>`).join('');
        document.getElementById('rep-i-srv').innerHTML = Store.state.servidores.map(s => `<option>${s.nome}</option>`).join('');
    },
    renderSrvList() {
        document.getElementById('srv-list').innerHTML = Store.state.servidores.map((s, i) => `
            <div class="srv-item" style="display:flex; justify-content:space-between; align-items:center">
                <span style="font-weight:700">${s.nome} ${s.atendimento?' üéß':''}</span>
                <button class="btn btn-outline" style="padding:4px 8px" onclick="UI.openSrv(${i})">‚öôÔ∏è</button>
            </div>`).join('');
    },
    renderAlerts() {
        const hoje = new Date();
        const limite = new Date(); limite.setDate(hoje.getDate() + 15);
        let html = "";
        Store.state.servidores.forEach(s => {
            s.occs.forEach(o => {
                const d1 = new Date(o.d1 + 'T00:00:00');
                if(d1 >= hoje && d1 <= limite && o.cat === "F√©rias") 
                    html += `<div class="alert-card">‚úàÔ∏è <b>${s.nome}</b>: ${Core.formatBR(o.d1)}</div>`;
            });
        });
        document.getElementById('alert-list').innerHTML = html || "<p style='font-size:10px; opacity:0.5'>Sem f√©rias pr√≥ximas.</p>";
    },
    renderCalendar() {
        const f = Store.state.dataFoco;
        document.getElementById('mes-label').innerText = f.toLocaleString('pt-br', {month:'long', year:'numeric'});
        const grid = document.getElementById('calendar-grid'); grid.innerHTML = '';
        const primDia = new Date(f.getFullYear(), f.getMonth(), 1).getDay();
        const diasMes = new Date(f.getFullYear(), f.getMonth()+1, 0).getDate();
        for(let i=0; i<primDia; i++) grid.innerHTML += '<div class="cal-day day-off"></div>';
        for(let i=1; i<=diasMes; i++) {
            const d = new Date(f.getFullYear(), f.getMonth(), i);
            const dStr = Core.formatISO(d);
            const feriado = Store.state.feriados.find(h => h.d === dStr);
            const isSel = d.toDateString() === Store.state.dataSel.toDateString();
            let atendentes = 0;
            Store.state.servidores.filter(s => s.atendimento).forEach(s => {
                if(Core.evaluate(s, d).code === 'PRESENT') atendentes++;
            });
            let indicador = "";
            if(d.getDay() > 0 && d.getDay() < 6 && !feriado) {
                if(atendentes <= 3) indicador = '<span class="status-dot dot-red"></span>';
                else if(atendentes <= 5) indicador = '<span class="status-dot dot-orange"></span>';
                else if(atendentes <= 7) indicador = '<span class="status-dot dot-green"></span>';
                else indicador = '<span class="emoji-happy">üòä</span>';
            }
            grid.innerHTML += `<div class="cal-day ${d.getDay()===0||d.getDay()===6?'day-off':''} ${feriado?'day-feriado':''} ${isSel?'day-selected':''}" onclick="UI.selectDay(new Date(${f.getFullYear()}, ${f.getMonth()}, ${i}))">
                    <span class="day-num">${i}</span>
                    <div style="font-size:8px; margin-top:5px">${feriado ? feriado.n : ''}</div>
                    ${indicador}
                </div>`;
        }
    },
    selectDay(data) {
        Store.state.dataSel = data;
        document.getElementById('sel-date-label').innerText = Core.formatBR(Core.formatISO(data));
        const pList = document.getElementById('presence-list'); pList.innerHTML = '';
        const aList = document.getElementById('absence-list'); aList.innerHTML = '';
        Store.state.servidores.forEach(s => {
            const res = Core.evaluate(s, data);
            if(res.code === 'PRESENT') pList.innerHTML += `<div class="srv-item"><b>${s.nome}</b> <span style="float:right">${res.h}</span></div>`;
            else if(res.code === 'ABSENT') aList.innerHTML += `<div class="srv-item" style="border-left:4px solid var(--red)"><b>${s.nome}</b> <span style="float:right; color:var(--red)">${res.label}</span></div>`;
        });
    },
    openSrv(idx) {
        const s = Store.state.servidores[idx];
        const m = document.getElementById('modal-srv');
        m.innerHTML = `
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h2>CONFIGURAR: ${s.nome}</h2>
                <div><label style="font-size:12px; margin-right:10px">SINALIZAR ATENDIMENTO?</label>
                <input type="checkbox" id="srv-atendimento" ${s.atendimento?'checked':''}></div>
            </div>
            <button class="btn btn-orange" style="margin-bottom:15px" onclick="Admin.replicateAll()">üîÑ REPLICAR SEGUNDA P/ SEMANA</button>
            <div style="display:grid; grid-template-columns: repeat(7, 1fr); gap:8px; margin-bottom:20px;">
                ${[0,1,2,3,4,5,6].map(d => {
                    const j = s.jornada[d] || {i:480, c: (d===0||d===6?0:7)};
                    return `<div class="j-card"><label>${["DOM","SEG","TER","QUA","QUI","SEX","SAB"][d]}</label>
                    <input type="time" class="j-in input-std" data-dia="${d}" value="${Core.toTime(j.i)}" onchange="Admin.autoCalcOut(${d})">
                    <input type="number" class="j-c input-std" data-dia="${d}" value="${j.c}" step="0.5" onchange="Admin.autoCalcOut(${d})">
                    <input type="time" class="j-out input-std" id="out-${d}" data-dia="${d}" value="${Core.toTime(j.i + (j.c*60))}"></div>`}).join('')}
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                <div class="glass">
                    <h4>REGISTRAR AUS√äNCIA</h4>
                    <select id="occ-cat" class="input-std">${Store.state.tiposOcc.map(t => `<option>${t}</option>`).join('')}</select>
                    <input type="date" id="occ-d1" class="input-std">
                    <input type="date" id="occ-d2" class="input-std" placeholder="Fim">
                    <button class="btn" style="width:100%" onclick="Admin.addOcc(${idx})">ADICIONAR</button>
                </div>
                <div class="glass" style="max-height:180px; overflow-y:auto">
                    <h4>HIST√ìRICO</h4>
                    ${s.occs.map((o, oi) => `<div style="font-size:10px; border-bottom:1px solid #333; padding:5px; display:flex; justify-content:space-between"><span>${o.cat} (${Core.formatBR(o.d1)})</span> <button onclick="Admin.delOcc(${idx},${oi})">X</button></div>`).join('')}
                </div>
            </div>
            <div style="margin-top:20px; display:flex; gap:10px">
                <button class="btn" style="flex:2; padding:15px" onclick="Admin.saveFullSrv(${idx})">üíæ SALVAR ALTERA√á√ïES</button>
                <button class="btn btn-outline" onclick="UI.closeModals()">FECHAR</button>
                <button class="btn btn-red" onclick="Admin.delSrv(${idx})">EXCLUIR SERVIDOR</button>
            </div>`;
        m.style.display='block'; document.getElementById('overlay').style.display='block';
    },
    showFeriados() {
        document.getElementById('fer-list-ui').innerHTML = Store.state.feriados.sort((a,b)=>a.d.localeCompare(b.d)).map((f, i) => `
            <div class="srv-item" style="display:flex; justify-content:space-between">
                <span><b>${Core.formatBR(f.d)}</b> - ${f.n}</span>
                <button class="btn btn-red btn-small" onclick="Admin.delFeriado(${i})">X</button>
            </div>`).join('');
        document.getElementById('modal-feriados').style.display='block'; document.getElementById('overlay').style.display='block';
    },
    showReports() { document.getElementById('modal-reports').style.display='block'; document.getElementById('overlay').style.display='block'; },
    renderApoio() {
        document.getElementById('apoio-srv').innerHTML = Store.state.servidores.map(s => `<option>${s.nome}</option>`).join('');
        const locais = [...new Set(Store.state.apoios.map(a => a.local))];
        let h = "";
        locais.forEach(local => {
            const lista = Store.state.apoios.filter(a => a.local === local).reverse();
            h += `<div class="srv-item"><h4>üìç ${local}</h4>${lista.slice(0,5).map(a=>`<div style="font-size:11px">‚Ä¢ ${a.nome} (${a.horas}h) - ${Core.formatBR(a.data)}</div>`).join('')}</div>`;
        });
        document.getElementById('locais-container').innerHTML = h || "Sem registros.";
        this.renderRanking();
    },
    renderRanking() {
        const stats = {};
        Store.state.apoios.forEach(a => {
            if(!stats[a.nome]) stats[a.nome] = { n: a.nome, t: 0, h: 0 };
            stats[a.nome].t++; stats[a.nome].h += parseFloat(a.horas);
        });
        const r = Object.values(stats).sort((a,b) => b.t - a.t || b.h - a.h);
        let table = `<table><tr><th>Servidor</th><th>Total Apoios</th><th>Horas Totais</th></tr>`;
        r.forEach(p => table += `<tr><td>${p.n}</td><td>${p.t}</td><td>${p.h}h</td></tr>`);
        document.getElementById('ranking-container').innerHTML = table + "</table>";
    },
    closeModals() { document.querySelectorAll('.modal').forEach(m => m.style.display='none'); document.getElementById('overlay').style.display='none'; },
    changeMonth(v) { Store.state.dataFoco.setMonth(Store.state.dataFoco.getMonth()+v); UI.render(); }
};

const Admin = {
    addSrv() { const n = prompt("Nome do Servidor:"); if(n) { Store.state.servidores.push({ nome: n, atendimento: false, jornada: { 1:{i:480,c:7}, 2:{i:480,c:7}, 3:{i:480,c:7}, 4:{i:480,c:7}, 5:{i:480,c:7} }, occs:[] }); Store.save(); } },
    autoCalcOut(dia) {
        const entrada = document.querySelector(`.j-in[data-dia="${dia}"]`).value;
        const carga = parseFloat(document.querySelector(`.j-c[data-dia="${dia}"]`).value);
        if(entrada && !isNaN(carga)) document.getElementById(`out-${dia}`).value = Core.toTime(Core.toMin(entrada) + (carga * 60));
    },
    replicateAll() {
        const segIn = document.querySelector(`.j-in[data-dia="1"]`).value;
        const segC = document.querySelector(`.j-c[data-dia="1"]`).value;
        for(let d=2; d<=5; d++) {
            document.querySelector(`.j-in[data-dia="${d}"]`).value = segIn;
            document.querySelector(`.j-c[data-dia="${d}"]`).value = segC;
            this.autoCalcOut(d);
        }
    },
    saveFullSrv(idx) {
        Store.state.servidores[idx].atendimento = document.getElementById('srv-atendimento').checked;
        for(let d=0; d<=6; d++) {
            const entrada = document.querySelector(`.j-in[data-dia="${d}"]`).value;
            const saida = document.getElementById(`out-${d}`).value;
            Store.state.servidores[idx].jornada[d] = { i: Core.toMin(entrada), c: (Core.toMin(saida) - Core.toMin(entrada)) / 60 };
        }
        Store.save(); UI.closeModals();
    },
    addOcc(idx) {
        const d1 = document.getElementById('occ-d1').value;
        if(d1) { Store.state.servidores[idx].occs.push({ cat: document.getElementById('occ-cat').value, d1, d2: document.getElementById('occ-d2').value }); UI.openSrv(idx); }
    },
    delOcc(sIdx, oIdx) { Store.state.servidores[sIdx].occs.splice(oIdx,1); UI.openSrv(sIdx); },
    saveFeriado() {
        const n = document.getElementById('fer-nome').value; const d = document.getElementById('fer-data').value;
        if(n && d) { Store.state.feriados.push({d, n}); Store.save(); UI.showFeriados(); }
    },
    delFeriado(i) { Store.state.feriados.splice(i,1); Store.save(); UI.showFeriados(); },
    saveApoio() {
        const nome = document.getElementById('apoio-srv').value;
        const local = document.getElementById('apoio-local').value;
        const horas = document.getElementById('apoio-horas').value;
        if(local) { Store.state.apoios.push({ nome, local, horas, data: Core.formatISO(new Date()) }); Store.save(); UI.renderApoio(); }
    },
    exportData() { Store.exportData(); },
    delSrv(idx) { if(confirm("Excluir?")) { Store.state.servidores.splice(idx,1); Store.save(); UI.closeModals(); } }
};

const Reports = {
    prepare(title) {
        const area = document.getElementById('report-print-area'); area.style.display = 'block';
        area.innerHTML = `<h1>COTEC - ${title}</h1><p>Emiss√£o: ${new Date().toLocaleString()}</p><button class="btn" onclick="window.print()">Imprimir</button>`;
        return area;
    },
    generateGeral() {
        const d1 = document.getElementById('rep-g-d1').value; const d2 = document.getElementById('rep-g-d2').value;
        const area = this.prepare("Relat√≥rio Geral");
        let html = "<table><tr><th>Data</th><th>Servidor</th><th>Status</th></tr>";
        let s = new Date(d1+'T00:00:00'); let e = new Date(d2+'T00:00:00');
        for(let d = new Date(s); d <= e; d.setDate(d.getDate()+1)) {
            Store.state.servidores.forEach(srv => {
                const res = Core.evaluate(srv, d);
                html += `<tr><td>${Core.formatBR(Core.formatISO(d))}</td><td>${srv.nome}</td><td>${res.label} ${res.h||''}</td></tr>`;
            });
        }
        area.innerHTML += html + "</table>";
    },
    generateHoras() {
        const d1 = document.getElementById('rep-h-d1').value; const d2 = document.getElementById('rep-h-d2').value;
        const area = this.prepare("Balan√ßo de Horas");
        let html = "<table><tr><th>Servidor</th><th>Horas Trabalhadas</th></tr>";
        Store.state.servidores.forEach(srv => {
            let total = 0; let s = new Date(d1+'T00:00:00'); let e = new Date(d2+'T00:00:00');
            for(let d = new Date(s); d <= e; d.setDate(d.getDate()+1)) {
                const res = Core.evaluate(srv, d);
                if(res.code === 'PRESENT') total += srv.jornada[d.getDay()]?.c || 0;
            }
            html += `<tr><td>${srv.nome}</td><td>${total}h</td></tr>`;
        });
        area.innerHTML += html + "</table>";
    },
    generateIndividual() {
        const sName = document.getElementById('rep-i-srv').value;
        const srv = Store.state.servidores.find(s => s.nome === sName);
        const area = this.prepare("Individual: " + srv.nome);
        area.innerHTML += "<h3>Hist√≥rico de Ocorr√™ncias</h3><table><tr><th>Data</th><th>Tipo</th></tr>" + 
            srv.occs.map(o => `<tr><td>${Core.formatBR(o.d1)}</td><td>${o.cat}</td></tr>`).join('') + "</table>";
    },
    generateEvento() {
        const tipo = document.getElementById('rep-e-tipo').value;
        const area = this.prepare("Busca por: " + tipo);
        let html = "<table><tr><th>Servidor</th><th>In√≠cio</th><th>Fim</th></tr>";
        Store.state.servidores.forEach(s => {
            s.occs.filter(o => o.cat === tipo).forEach(o => {
                html += `<tr><td>${s.nome}</td><td>${Core.formatBR(o.d1)}</td><td>${Core.formatBR(o.d2)}</td></tr>`;
            });
        });
        area.innerHTML += html + "</table>";
    }
};

window.onload = () => Store.init();
</script>
</body>
</html>